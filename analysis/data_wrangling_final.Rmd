---
title: "Data wrangling for Class Project"
author: "Maggie Douglas"
date: "2026-02-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Purpose

This code is meant to match PPL data to building information and reorganize it to generate electricity data by building (or combinations of buildings for those metered together). 

The main steps involved are:

+ Read in the PPL electricity data, building information data, and a key to connect them by name
    + Create and store an annual summary of the electricity data by meter
+ Restructure the building data to generate a single row for the Main Meter and Weis Meter buildings
+ Join PPL electricity data (daily and annual) to building information using a key that connects the two by building name
+ Aggregate electricity and square footage data by building and calculate electricity use per square foot, estimated cost, and estimated associated GHG emissions
+ Inspect the data using a table
+ Export the cleaned and reorganized data for downstream analyses

## Load libraries + data

```{r load}
library(tidyverse) # load tidyverse
library(DT) # library to create tables
library(scales) # library to format dollars

# load electricity data
kwh <- read.csv("./data/FY25 PPL Electricity Data.csv", strip.white = T) # load PPL data
kwh_sub <- read.csv("./output/kwh_main_daily.csv", strip.white = T)

# load building data + occupancy
buildings <- read.csv("./keys/fy25_building_list_updated.csv", strip.white = T) # load building information
occupants <- read.csv("./keys/housing_counts.csv", strip.white = T) # load occupancy info

# load keys to link datasets
key <- read.csv("./keys/meter_building_key.csv", strip.white = T) # load key to link meters to buildings
sub_key <- read.csv("./keys/submeter_building_key.csv", strip.white = T) # key to link submeter names to buildings

# filter to AY24/25 and average across the year
occu_agg <- occupants %>%
  mutate(sem_yr = paste(semester, year)) %>%
  filter(sem_yr %in% c("Fall 2024", "Spring 2025")) %>%
  group_by(NAME, sem_yr) %>%
  summarize(occupants = sum(occupants, na.rm = T),
            n = n()) %>%
  group_by(NAME) %>%
  summarize(occupants = mean(occupants, na.rm = T))

# store annual totals for kWh
kwh_annual <- kwh %>%
  filter(!is.na(total_kwh)) %>%
  group_by(meter_origin) %>%
  summarize(kwh = sum(total_kwh, na.rm = T),
            days_perc = (n()/365)*100)

kwh_sub_annual <- kwh_sub %>%
  filter(!is.na(kwh)) %>%
  group_by(building) %>%
  summarize(kwh = sum(kwh, na.rm = T),
            days_perc = (n()/365)*100)

# store conversion factors
dollars_kwh <- 0.08138507
co2_kg_kwh <- 0.30082405
```

## Check data

```{r check}
str(kwh)
str(buildings)
str(key)
```

## Restructure building data 

+ Generate total square footage for buildings on the Main Meter and fill in values for other variables
+ Similar operation for buildings on the Weis Meter
+ Filter building info to those with individual meters and then add back in the Main Meter and Weis aggregated information

```{r restructure}
buildings_main <- buildings %>%
  filter(main_meter == 1) %>% # filter to main meter buildings
  summarize(sqft = sum(sqft, na.rm = T)) %>% # sum sqft for these buildings
  mutate(meter = "Main Meter - Total",
         NAME = "Main Meter",
         type_new = "Main Meter",
         occupant = "Mixed",
         address = "Many different",
         date_constr = NA,
         date_acqd = NA,
         date_reno = NA,
         rental = 0)

buildings_weis <- buildings %>%
  filter(weis_meter == 1) %>% # filter to weis buildings
  summarize(sqft = sum(sqft, na.rm = T)) %>%
    mutate(meter = "Weis Meter - Total",
           NAME = "Weis Meter",
         type_new = "Weis Meter",
         occupant = "Mixed",
         address = "Many different",
         date_constr = NA,
         date_acqd = NA,
         date_reno = NA,
         rental = 0)

# Generate clean building lookup table
buildings_clean <- buildings %>%
  filter(main_disagg == 1 | weis_meter == 0) %>% # keep only buildings on individual meters
  mutate(meter = ifelse(weis_meter == 1, "Weis Meter", 
                        ifelse(main_meter == 1 & main_disagg == 0, "Main Meter", 
                               ifelse(main_meter == 1 & main_disagg == 1, "Main Meter - Disagg.", "Individual")))) %>%
  select(meter, NAME, type_new, occupant, address, date_constr, date_acqd, date_reno, sqft, rental) %>% # select relevant columns
  rbind(buildings_main, buildings_weis) %>%
  select(type_new, NAME, sqft, meter)

# Store summary of building meter status
buildings_sum <- buildings %>%
    mutate(meter = ifelse(weis_meter == 1, "Weis Meter", 
                        ifelse(main_meter == 1 & main_disagg == 0, "Main Meter", 
                               ifelse(main_meter == 1 & main_disagg == 1, "Main Meter - Disagg.", "Individual"))))
  
```

## Wrangle datasets

### Annual totals

```{r annual}
joined <- kwh_annual %>%
  left_join(key, by = "meter_origin") %>% # join to key to match meters to building names
  full_join(buildings_clean, by = "NAME", relationship = "many-to-one") %>% # join to building info by name
  filter(!meter %in% c("Main Meter", "Weis Meter")) %>% # filter out those on main or Weis meter (not disagg or total)
  group_by(type_new, NAME, days_perc, meter) %>% # group by building
  summarize(kwh = sum(kwh, na.rm = T), # sum kwh by building
            sqft = mean(sqft, na.rm = T)) %>% # take mean to preserve sqft data
  filter(!is.na(type_new)) %>% # filter out those with NA for type
  filter(meter != "Main Meter - Disagg.") %>% # filter out those with submeter data
  left_join(occu_agg, by = "NAME") %>%
  mutate(kwh_sqft = kwh/sqft, # calculate kwh per sqft
         kwh_person = kwh/occupants,
         dollars = kwh*dollars_kwh,
         ghg_kgCO2 = kwh*co2_kg_kwh,
         type = type_new) %>% 
  ungroup() %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) %>%
  select(type, meter, NAME, days_perc, kwh, sqft, kwh_sqft, occupants, kwh_person, dollars, ghg_kgCO2)

joined_sub <- kwh_sub_annual %>%
  left_join(sub_key, by = "building") %>%
  left_join(buildings_clean, by = "NAME", relationship = "many-to-one") %>% # join to building info by name
  group_by(type_new, NAME, days_perc, meter) %>% # group by building
  summarize(kwh = sum(kwh, na.rm = T), # sum kwh by building
            sqft = mean(sqft, na.rm = T)) %>% # take mean to preserve sqft data
  filter(!is.na(type_new)) %>% # filter out those with NA for type
  left_join(occu_agg, by = "NAME") %>%
  mutate(kwh_sqft = kwh/sqft, # calculate kwh per sqft
         kwh_person = kwh/occupants,
         dollars = kwh*dollars_kwh,
         ghg_kgCO2 = kwh*co2_kg_kwh,
         type = type_new) %>% 
  ungroup() %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) %>%
  select(type, meter, NAME, days_perc, kwh, sqft, kwh_sqft, occupants, kwh_person, dollars, ghg_kgCO2)

joined_full <- rbind(joined, joined_sub)

# generate summary by building category
joined_cat <- joined_full %>%
  group_by(type) %>%
  summarize(n = n(),
            kwh = sum(kwh),
            dollars = sum(dollars),
            ghg_kgCO2 = sum(ghg_kgCO2),
            sqft = sum(sqft, na.rm = T),
            med_kwh_sqft = median(kwh_sqft, na.rm = T),
            kwh_sqft_25 = quantile(kwh_sqft, .25, na.rm = T),
            kwh_sqft_75 = quantile(kwh_sqft, .75, na.rm = T)) %>%
  arrange(-kwh)
```

### Daily data

```{r split}
joined_daily <- kwh %>%
  left_join(key, by = "meter_origin") %>% # join to key to match meters to building names
  full_join(buildings_clean, by = "NAME", relationship = "many-to-many") %>% # join to building info by name
  filter(!is.na(meter_origin)) %>%
  group_by(type_new, NAME, date) %>%
  summarize(kwh = sum(total_kwh, na.rm = T),
            sqft = mean(sqft, na.rm = T),
            ave_temp = mean(ave_temp, na.rm = T)) %>%
  left_join(occu_agg, by = "NAME") %>%
  filter(!is.na(type_new)) %>%
  mutate(type = type_new) %>% 
  ungroup() %>%
  select(type, NAME, date, ave_temp, kwh, sqft, occupants) %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) # convert NaN to NA

joined_daily_sub <- kwh_sub %>%
  left_join(sub_key, by = "building") %>% 
  full_join(buildings_clean, by = "NAME", relationship = "many-to-many") %>% # join to building info by name
  group_by(type_new, NAME, date) %>%
  summarize(kwh = sum(kwh, na.rm = T),
            sqft = mean(sqft, na.rm = T),
            ave_temp = mean(ave_temp, na.rm = T)) %>%
  left_join(occu_agg, by = "NAME") %>%
  filter(!is.na(type_new)) %>%
  mutate(type = type_new) %>% 
  ungroup() %>%
  select(type, NAME, date, ave_temp, kwh, sqft, occupants) %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) # convert NaN to NA

joined_daily_full <- rbind(joined_daily, joined_daily_sub)
```

## Summary table

```{r cat table}
joined_pretty_cat <- joined_cat %>%
  mutate(n = ifelse(n == 1, "-", n),
         kwh = round(kwh, digits = 0),
         dollars = paste("$",round(dollars, digits = 0)),
         ghg_MTCO2 = round(ghg_kgCO2/1000, digits = 0),
         sqft = round(sqft, digits = 0),
         med_kwh_sqft = round(med_kwh_sqft, digits = 1),
         kwh_sqft_25 = ifelse(n == 1, "-", round(kwh_sqft_25, digits = 1)),
         kwh_sqft_75 = ifelse(n == 1, "-", round(kwh_sqft_75, digits = 1))) %>%
    select(type, n, kwh, dollars, ghg_MTCO2, sqft, med_kwh_sqft, kwh_sqft_25, kwh_sqft_75) %>% 
  arrange(desc(kwh))
```

```{r annual table cat}
datatable(joined_pretty_cat,
          filter = 'top',
          rownames = FALSE,
          colnames = c("Building\ntype","Buildings\nwith data", "kWh", "Est. cost", 
                       "CO2e\n(MT)", "Square\nfootage", "Median\nkWh\nper sqft",
                       "25th Perc.", "75th Perc."),
          caption = "Table 1. Descriptive statistics for annual electricity use by building type.")
```

```{r annual table, include = FALSE, eval = FALSE}
joined_pretty <- joined_full %>%
  mutate(kwh = round(kwh, digits = 0),
         dollars = paste("$",round(dollars, digits = 0)),
         kwh_sqft = round(kwh_sqft, digits = 1),
         kwh_person = round(kwh_person, digits = 0),
         days_perc = round(days_perc, digits = 0)) %>%
  select(type, NAME, kwh, dollars, kwh_sqft, kwh_person, days_perc) %>% 
  arrange(desc(kwh))

datatable(joined_pretty,
          filter = 'top',
          rownames = FALSE,
          colnames = c("Building\ntype","Name","kWh", "Est cost", "kWh\nper sqft",
                       "kWh\nper person","Days of\ndata (%)"))
```

## Summary graph by meter status

```{r graph meter, warning = F}
ggplot(filter(buildings_sum, !is.na(meter) & !type_new %in% c("Res Hall - U","Non-building","Production")),
       aes(x = reorder(type_new, sqft, FUN = "sum"), y = sqft/1000, fill = meter)) +
  geom_col(position = "stack") +
  theme_bw() +
  labs(x = "", y = "Square footage (1000)", fill = "Meter status")
```


```{r stacked bar}
daily_graph <- joined_daily %>%
  mutate(date = mdy(date),
         month = month(date, label = TRUE),
         day = wday(date, label = TRUE))

ggplot(daily_graph, aes(x = month, y = kwh/10^6, fill = reorder(type, kwh, FUN = 'sum'))) +
  geom_col(position = "stack") +
  theme_bw() +
  labs(x = "", y = "Electricity use (million kWh)", fill = "")
```

```{r stacked bar facet}
ggplot(daily_graph, aes(x = month, y = kwh/10^6, fill = reorder(type, kwh, FUN = 'sum'))) +
  geom_col(position = "stack") +
  facet_wrap(. ~ type) +
  theme_bw() +
  labs(x = "", y = "Electricity use (million kWh)", fill = "") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```
```{r stacked bar facet axis variable}
ggplot(daily_graph, aes(x = month, y = kwh/10^6, fill = reorder(type, kwh, FUN = 'sum'))) +
  geom_col(position = "stack") +
  facet_wrap(. ~ type, scales = "free") +
  theme_bw() +
  labs(x = "", y = "Electricity use (million kWh)", fill = "") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Summary graph of electricity intensity - TBD

```{r intensity, eval = FALSE}
joined_sum <- joined_daily %>%
  group_by(type, NAME) %>%
  summarize(kwh = sum(kwh, na.rm = T),
            sqft = median(sqft, na.rm = T)) %>%

ggplot(joined_sum, aes(x = type, y = kwh_sqft, fill = type)) +
  geom_boxplot() +
  coord_flip() +
  theme_bw() +
  labs(x = "", y = "kWh per sqft", )
```

## Export for downstream analyses

```{r export}
write.csv(joined_daily_full, "./output/kwh_daily_20260225.csv", row.names = F)
write.csv(joined_full, "./output/kwh_annual_20260225.csv", row.names = F)
```

