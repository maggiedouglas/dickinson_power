---
title: "Data wrangling for Class Project"
author: "Maggie Douglas"
date: "2026-02-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Purpose

This code is meant to match PPL data to building information and reorganize it to generate electricity data by building (or combinations of buildings for those metered together). 

The main steps involved are:

+ Read in the PPL electricity data, building information data, and a key to connect them by name
    + Create and store an annual summary of the electricity data by meter
+ Restructure the building data to generate a single row for the Main Meter and Weis Meter buildings
+ Join PPL electricity data (daily and annual) to building information using a key that connects the two by building name
+ Aggregate electricity and square footage data by building and calculate electricity use per square foot, estimated cost, and estimated associated GHG emissions
+ Inspect the data using a table
+ Export the cleaned and reorganized data for downstream analyses

## Load libraries + data

```{r load}
library(tidyverse) # load tidyverse
library(DT) # library to create tables
library(scales) # library to format dollars
library(RColorBrewer)

# load electricity data + reformat date
kwh <- read.csv("./data/FY25 PPL Electricity Data.csv", strip.white = T, encoding = "UTF-8") %>%
  mutate(date = mdy(date))
  
kwh_sub <- read.csv("./output/kwh_main_daily.csv", strip.white = T, encoding = "UTF-8") %>%
  mutate(date = ymd(date))
  
# load building data + clean up building names
buildings <- read.csv("./keys/fy25_building_list_updated.csv", 
                      strip.white = T, encoding = "UTF-8") %>%
  mutate(NAME = str_remove_all(NAME, "/"),
         NAME = str_replace_all(NAME, "  "," "),
         NAME = str_replace_all(NAME, "   "," "))

# load occupancy and clean up building names
occupants <- read.csv("./keys/occupancy_key.csv", 
                      strip.white = T, encoding = "UTF-8") %>%
  mutate(NAME = str_remove_all(NAME, "/"),
         NAME = str_replace_all(NAME, "  "," "),
         NAME = str_replace_all(NAME, "   "," "))

# load keys to link datasets
key <- read.csv("./keys/meter_building_key.csv", strip.white = T, encoding = "UTF-8") %>%
  mutate(NAME = str_remove_all(NAME, "/"),
         NAME = str_replace_all(NAME, "  "," "),
         NAME = str_replace_all(NAME, "   "," "))

key_sub <- read.csv("./keys/submeter_building_key.csv", strip.white = T, encoding = "UTF-8") %>%
  mutate(NAME = str_remove_all(NAME, "/"),
         NAME = str_replace_all(NAME, "  "," "),
         NAME = str_replace_all(NAME, "   "," ")) 

# store annual totals for kWh
kwh_annual <- kwh %>%
  filter(!is.na(total_kwh)) %>%
  group_by(meter_origin) %>%
  summarize(kwh = sum(total_kwh, na.rm = T),
            days_perc = (n()/365)*100)

kwh_sub_annual <- kwh_sub %>%
  filter(!is.na(kwh)) %>%
  group_by(building) %>%
  summarize(kwh = sum(kwh, na.rm = T),
            days_perc = (n()/365)*100)

# store conversion factors
dollars_kwh <- 0.08138507
co2_kg_kwh <- 0.30082405
```

## Check data

```{r check}
str(kwh)
str(buildings)
str(key)
```

## Restructure building data 

+ Generate total square footage for buildings on the Main Meter and fill in values for other variables
+ Similar operation for buildings on the Weis Meter
+ Filter building info to those with individual meters and then add back in the Main Meter and Weis aggregated information

```{r restructure}
# Generate lookup table for each meter status

buildings_main <- buildings %>%
  filter(main_meter == 1) %>% # filter to main meter buildings
  summarize(sqft = sum(sqft, na.rm = T)) %>% # sum sqft for these buildings
  mutate(meter = "Main Meter - Total",
         NAME = "Main Meter",
         type_new = "Main Meter") %>%
    select(type_new, NAME, sqft, meter)

buildings_weis <- buildings %>%
  filter(weis_meter == 1) %>% # filter to weis buildings
  summarize(sqft = sum(sqft, na.rm = T)) %>%
    mutate(meter = "Weis Meter - Total",
           NAME = "Weis Meter",
         type_new = "Weis Meter") %>%
    select(type_new, NAME, sqft, meter)

buildings_agg <- rbind(buildings_main, buildings_weis)

buildings_individual <- buildings %>%
  filter(main_meter == 0 & weis_meter == 0) %>% # keep only buildings on individual meters
  mutate(meter = "Individual") %>%
  select(meter, NAME, type_new, occupant, address, date_constr, date_acqd, date_reno, sqft, rental) %>% # select relevant columns
 # rbind(buildings_main, buildings_weis) %>%
  select(type_new, NAME, sqft, meter) 

buildings_submeter <- buildings %>%
  filter(main_disagg ==1) %>% # keep only buildings on individual meters
  mutate(meter = "Submeter") %>%
  select(meter, NAME, type_new, occupant, address, date_constr, date_acqd, date_reno, sqft, rental) %>% # select relevant columns
 # rbind(buildings_main, buildings_weis) %>%
  select(type_new, NAME, sqft, meter)

# Store summary of building meter status
buildings_sum <- buildings %>%
    mutate(meter = ifelse(weis_meter == 1, "Weis Meter", 
                        ifelse(main_meter == 1 & main_disagg == 0, "Main Meter", 
                               ifelse(main_disagg == 1, "Submeter", "Individual"))))
```

## Wrangle datasets

### Annual totals

```{r annual}
# generate annual summary for individually metered buildings
joined_individual <- kwh_annual %>%
  left_join(key, by = "meter_origin") %>% # join to key to match meters to building names
  right_join(buildings_individual, by = "NAME", relationship = "many-to-one") %>% # join to building info by name
  group_by(type_new, NAME, days_perc, meter) %>% # group by building
  summarize(kwh = sum(kwh, na.rm = T), # sum kwh by building
            sqft = mean(sqft, na.rm = T)) %>% # take mean to preserve sqft data
  left_join(occupants, by = "NAME") %>%
  mutate(kwh_sqft = kwh/sqft, # calculate kwh per sqft
         kwh_person = kwh/occupants,
         dollars = kwh*dollars_kwh,
         ghg_kgCO2 = kwh*co2_kg_kwh,
         type = type_new) %>% 
  ungroup() %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) %>%
  select(type, meter, NAME, days_perc, kwh, sqft, kwh_sqft, occupants, kwh_person, dollars, ghg_kgCO2)

# generate annual summary for submetered buildings
joined_sub <- kwh_sub_annual %>%
  left_join(key_sub, by = "building") %>%
  left_join(buildings_submeter, by = "NAME", relationship = "many-to-one") %>% # join to building info by name
  filter(building != "CHW_Base") %>% # remove duplicate CHW value - not sure what this is?
  group_by(type_new, NAME, days_perc, meter) %>% # group by building
  summarize(kwh = sum(kwh, na.rm = T), # sum kwh by building
            sqft = mean(sqft, na.rm = T)) %>% # preserve sqft as is
 # filter(!is.na(type_new)) %>% # filter out those with NA for type
  left_join(occupants, by = "NAME") %>%
  mutate(kwh_sqft = kwh/sqft, # calculate kwh per sqft
         kwh_person = kwh/occupants,
         dollars = kwh*dollars_kwh,
         ghg_kgCO2 = kwh*co2_kg_kwh,
         type = type_new) %>% 
  ungroup() %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) %>%
  select(type, meter, NAME, days_perc, kwh, sqft, kwh_sqft, occupants, kwh_person, dollars, ghg_kgCO2)

# generate annual summary for main and weis meters
joined_agg <- kwh_annual %>%
  left_join(key, by = "meter_origin") %>%
  right_join(buildings_agg, by = "NAME") %>%
  group_by(type_new, NAME, days_perc, meter) %>% # group by building
  summarize(kwh = sum(kwh, na.rm = T), # sum kwh by building
            sqft = mean(sqft, na.rm = T)) %>% # preserve sqft as is
 # filter(!is.na(type_new)) %>% # filter out those with NA for type
  left_join(occupants, by = "NAME") %>%
  mutate(kwh_sqft = kwh/sqft, # calculate kwh per sqft
         kwh_person = kwh/occupants,
         dollars = kwh*dollars_kwh,
         ghg_kgCO2 = kwh*co2_kg_kwh,
         type = type_new) %>% 
  ungroup() %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) %>%
  select(type, meter, NAME, days_perc, kwh, sqft, kwh_sqft, occupants, kwh_person, dollars, ghg_kgCO2)

# combine into one data frame
joined_full <- rbind(joined_individual, joined_sub, joined_agg) %>%
  filter(kwh != 0)

# generate summary by building category
joined_cat <- joined_full %>%
  group_by(type) %>%
  summarize(n = n(),
            kwh = sum(kwh),
            dollars = sum(dollars),
            ghg_kgCO2 = sum(ghg_kgCO2),
            sqft = sum(sqft, na.rm = T),
            med_kwh_sqft = median(kwh_sqft, na.rm = T),
            kwh_sqft_25 = quantile(kwh_sqft, .25, na.rm = T),
            kwh_sqft_75 = quantile(kwh_sqft, .75, na.rm = T)) %>%
  arrange(-kwh)
```

### Daily data

```{r split}
# generate daily summary for individually metered buildings
daily_individual <- kwh %>%
  left_join(key, by = "meter_origin") %>% # join to key to match meters to building names
  right_join(buildings_individual, by = "NAME", relationship = "many-to-many") %>% # join to building info by name
  group_by(type_new, NAME, date, meter) %>% # group by building
  summarize(kwh = sum(total_kwh, na.rm = T), # sum kwh by building
            sqft = mean(sqft, na.rm = T),
            ave_temp = mean(ave_temp, na.rm = T)) %>%
  mutate(kwh_sqft = kwh/sqft, # calculate kwh per sqft
         type = type_new) %>% 
  ungroup() %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) %>% # convert NaN to NA
  select(type, meter, date, NAME, kwh, sqft, kwh_sqft, ave_temp)

# generate daily summary for submetered buildings
daily_sub <- kwh_sub %>%
  left_join(key_sub, by = "building") %>%
  left_join(buildings_submeter, by = "NAME", relationship = "many-to-one") %>% # join to building info by name
  filter(building != "CHW_Base") %>% # remove duplicate CHW value - not sure what this is?
  group_by(type_new, NAME, date, meter) %>% # group by building
  summarize(kwh = sum(kwh, na.rm = T),
            sqft = mean(sqft, na.rm = T),
            ave_temp = mean(ave_temp, na.rm = T)) %>%
  filter(!is.na(type_new)) %>%
  mutate(kwh_sqft = kwh/sqft, # calculate kwh per sqft
         type = type_new) %>% 
  ungroup() %>%
  select(type, meter, date, NAME, kwh, sqft, kwh_sqft, ave_temp) %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) # convert NaN to NA

# generate daily summary for main and weis meters
daily_agg <- kwh %>%
  left_join(key, by = "meter_origin") %>%
  right_join(buildings_agg, by = "NAME") %>%
  group_by(type_new, NAME, date, meter) %>% # group by building
  summarize(kwh = sum(total_kwh, na.rm = T), # sum kwh by building
            sqft = mean(sqft, na.rm = T),
            ave_temp = mean(ave_temp, na.rm = T)) %>% # preserve sqft as is
 # filter(!is.na(type_new)) %>% # filter out those with NA for type
  mutate(kwh_sqft = kwh/sqft, # calculate kwh per sqft
         type = type_new) %>% 
  ungroup() %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) %>%
  select(type, meter, date, NAME, kwh, sqft, kwh_sqft, ave_temp)

# generate complete daily dataset
daily_full <- rbind(daily_individual, daily_agg, daily_sub)
```

## Summary

### Building type summary

```{r cat table}
joined_pretty_cat <- joined_cat %>%
  mutate(n = ifelse(n == 1, "-", n),
         kwh = round(kwh, digits = 0),
         dollars = paste("$",round(dollars, digits = 0)),
         ghg_MTCO2 = round(ghg_kgCO2/1000, digits = 0),
         sqft = round(sqft, digits = 0),
         med_kwh_sqft = round(med_kwh_sqft, digits = 1),
         kwh_sqft_25 = round(kwh_sqft_25, digits = 1),
         kwh_sqft_75 = round(kwh_sqft_75, digits = 1)) %>%
    select(type, n, kwh, dollars, ghg_MTCO2, sqft, med_kwh_sqft, kwh_sqft_25, kwh_sqft_75) %>% 
  arrange(desc(med_kwh_sqft))
```

```{r annual table cat}
datatable(joined_pretty_cat,
          filter = 'top',
          rownames = FALSE,
          colnames = c("Building\ntype","Buildings\nwith data", "kWh", "Est. cost", 
                       "CO2e\n(MT)", "Square\nfootage", "Median\nkWh\nper sqft",
                       "25th Perc.", "75th Perc."),
          caption = "Table 1. Descriptive statistics for annual electricity use by building type.")
```

```{r annual table, eval = FALSE, include = FALSE}
joined_pretty <- joined_full %>%
  mutate(kwh = round(kwh, digits = 0),
         dollars = paste("$",round(dollars, digits = 0)),
         kwh_sqft = round(kwh_sqft, digits = 1),
         kwh_person = round(kwh_person, digits = 0),
         days_perc = round(days_perc, digits = 0)) %>%
  select(type, NAME, kwh, dollars, kwh_sqft, kwh_person, days_perc) %>% 
  arrange(desc(kwh))

datatable(joined_pretty,
          filter = 'top',
          rownames = FALSE,
          colnames = c("Building\ntype","Name","kWh", "Est cost", "kWh\nper sqft",
                       "kWh\nper person","Days of\ndata (%)"))
```

### Data availability by type

```{r graph meter, warning = F, fig.height = 3, fig.height = 4.5}
buildings_sum$meter <- factor(buildings_sum$meter,
                              levels = c("Weis Meter", "Main Meter",
                                        "Submeter", "Individual"))

pal <- c("grey","grey","#CAB2D6","#6A3D9A")

buildings_graph <- buildings_sum %>%
  filter(!is.na(meter) & !type_new %in% c("Res Hall - U","Non-building","Production","Mixed"))

ggplot(buildings_graph,
       aes(x = reorder(type_new, sqft, FUN = "sum"), y = sqft/1000, fill = meter)) +
  geom_col(position = "stack") +
  scale_fill_manual(values = pal) +
  theme_bw() +
  labs(x = "", y = "Square Footage (1000)", fill = "Meter status") +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplot(buildings_graph, 
       aes(x = reorder(type_new, sqft, FUN = "sum"), fill = meter)) +
  geom_bar(position = "stack") +
  scale_fill_manual(values = pal) +
  theme_bw() +
  labs(x = "", y = "Number of Buildings", fill = "Meter status") +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

```{r stacked bar, warning = F, fig.height = 4, fig.height = 4.5}
daily_graph <- daily_full %>%
  mutate(date = as_date(date),
         month = month(date, label = TRUE),
         day = wday(date, label = TRUE),
         type_brief = recode(type,
                       'Res Hall - U' = 'Res Hall',
                       'Res Hall - S' = 'Res Hall',
                       'Res Hall - M' = 'Res Hall',
                       'Res Hall - L' = 'Res Hall')) %>%
  filter(!is.na(month))

ggplot(filter(daily_graph, meter != "Submeter"),
       aes(x = month, y = kwh/10^6, fill = reorder(type_brief, kwh, FUN = sum))) +
  geom_col(position = "stack") +
  scale_fill_brewer(type = "qual", palette = "Paired") +
  theme_bw() +
  labs(x = "", y = "Electricity use (million kWh)", fill = "",
       title = "Electricity use by building type")

ggplot(filter(daily_graph, meter == "Submeter"),
       aes(x = month, y = kwh/10^6, fill = reorder(type_brief, kwh, FUN = sum))) +
  geom_col(position = "stack") +
  scale_fill_brewer(type = "qual", palette = "Paired") +
  theme_bw() +
  labs(x = "", y = "Electricity use (million kWh)", fill = "",
       title = "Electricity data from the submeters")
```

```{r stacked bar facet axis variable}
ggplot(daily_graph, aes(x = month, y = kwh/10^6, fill = reorder(type, kwh, FUN = 'sum'))) +
  geom_col(position = "stack") +
  facet_wrap(. ~ type, scales = "free") +
  theme_bw() +
  labs(x = "", y = "Electricity use (million kWh)", fill = "") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  theme(legend.position = "none")
```

## Summary statistics
```{r summary stat}
summary(joined_full)

## Stats for campus buildings
stats <- filter(joined_full, meter != "Submeter" & type != "Production")
 # million square feet
(sum(joined_agg$sqft, na.rm=T) + sum(joined_individual$sqft, na.rm=T))/10^6
sum(stats$kwh)/10^6 # million kwh
sum(stats$dollars)/10^6 # million $
sum(stats$ghg_kgCO2)/1000 # MT CO2e

## Stats for solar
solar <- filter(joined_full, type == "Production")
sum(solar$kwh)/10^6 # million kwh
sum(solar$dollars)/10^6 # million $
sum(solar$ghg_kgCO2)/1000 # MT CO2e
```

### Electricity intensity by type

```{r intensity, warning = F, fig.height = 3.5, fig.width = 4.5}
to_exclude <- filter(joined_full, days_perc < 90)

intensity <- joined_full %>%
  filter(!(type %in% c("Res Hall - U","Production", "Non-building")) 
              & !(NAME %in% to_exclude$NAME))

# median and IQR come from EIA (2022) table, annual kWh per square foot for Colleges/Universities
# https://www.eia.gov/consumption/commercial/data/2018/ce/pdf/c22.pdf

ggplot(intensity,
       aes(x = reorder(type, kwh_sqft, FUN = "median"),
                        y = kwh_sqft, fill = type)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 7.4, ymax = 14.3, color = "lightgray", alpha = 0.3) +
  geom_hline(yintercept = 10.3, linetype = "dashed", color = "white") +
  geom_boxplot() +
  coord_flip() +
  theme_bw() +
  theme(legend.position = "none") +
  labs(x = "", y = "kWh per sqft per year", 
       title = "Electricity Intensity by Building Type")
```

## Export for downstream analyses

```{r export}
joined_exp <- select(joined_full,
                     type, meter, NAME, kwh, sqft, occupants)
daily_exp <- select(daily_full,
                    type, meter, NAME, date, kwh, sqft, ave_temp)

write.csv(daily_exp, "./output/kwh_daily_20260226.csv", row.names = F)
write.csv(joined_exp, "./output/kwh_annual_20260226.csv", row.names = F)
```

